---
title: "Biodiversity"
format: 
  html:
    include-after-body: |
      <script type="module">
        import {Plot} from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
        import {Inputs} from "https://cdn.jsdelivr.net/npm/@observablehq/inputs@0.10/+esm";
      </script>
bibliography: references.bib
---

Passive acoustics can serve to assess overall biodiversity and changes in biodiversity. Here we present alternative visualizations and analyses to serve as an introduction to the possibilities. All results are preliminary and analyses are conducted on recordings from the Tijuana Estuary (TJE).

## Diurnal vocalizations recorded near the Proving Pens

Need to fix this so that I am using the appropriate data here

```{r RailPrep}
#| echo: false
#| include: false
library(here)
here()

source(here::here("_code/_common.R"))

birdnet_all <- readRDS(here("data/birdnet_rails_48c.rds"))

priority <- birdnet_all %>%
  filter(location == "TJE") %>%
  count(common_name, sort = TRUE) %>% 
  slice_head(n = 10) %>%
  pull(common_name) %>% 
  union("Ridgway's Rail") 

birdnet_top_TJE <- birdnet_all %>%
  filter(location == "TJE") %>%
  filter(common_name %in% priority)

myData_priority_TJE <- loadDetectionData(x=birdnet_top_TJE, source='csv', detectionType='detection', wide=FALSE,  tz='UTC', columnMap=list(UTC='utc', species='common_name', Latitude='latitude', Longitude='longitude'))

myData_rails_48c_tje <- loadDetectionData(x=birdnet_top_TJE, source = 'csv', detectionType='detection', wide=FALSE, tz='Etc/GMT-7', columnMap=list(UTC='utc', species='common_name', Latitude='latitude', Longitude='longitude'), extraCols= c('site', 'location'))

# prep data to json for use in ojs:
library(jsonlite)
myData_json <- jsonlite::toJSON(birdnet_top_TJE, pretty = TRUE, na = "null")
cat(myData_json, file = "data.json")  # Save as a file for JS to read

birdnet_tje_bins <- readRDS(here("data/birdnet_rails_48c_bins_day.rds")) %>%
  clean_names()

# myData_rails_48c_tje <- loadDetectionData(x=birdnet_top_TJE, source = 'csv', detectionType='detection', wide=FALSE, tz='Etc/GMT-7', columnMap=list(UTC='utc', species='common_name', Latitude='latitude', Longitude='longitude'), extraCols= c('site', 'location'))
# 
# myData_rails_48c_tje_bins <- loadDetectionData(x=birdnet_tje_bins, source = 'csv', detectionType='detection', wide=FALSE, tz='Etc/GMT-7', columnMap=list(UTC='utc', species='common_name', Latitude='latitude', Longitude='longitude'))

# myData_rails_48c_tje <- loadDetectionData(x=birdnet_rails_48c_tje, source = 'csv', detectionType='detection', wide=FALSE, tz='Etc/GMT-7', columnMap=list(UTC='utc', species='common_name', Latitude='latitude', Longitude='longitude'), extraCols= c('site', 'location'))
# 
# # prep data to json for use in ojs:
# library(jsonlite)
# myData_json <- jsonlite::toJSON(myData_rails_48c_spp1Ntje, pretty = TRUE, na = "null")
# cat(myData_json, file = "data.json")  # Save as a file for JS to read

```
Diurnal Variation


```{r RailPolarPlot}
#| echo: false
#| warning: false

plotPolarDetections(x=myData_priority_TJE, facet='species',  bin='detection/hour', quantity='count')

```

```{js echo=FALSE}
<!-- // Load the data -->
<!-- const data = FileAttachment("data.json").json(); -->

<!-- // Get unique species for the dropdown -->
<!-- const species = [...new Set(data.map(d => d.common_name))]; -->

<!-- // Create a dropdown -->
<!-- const dropdown = Inputs.select(species, {label: "Select Species", value: species[0]}); -->

<!-- // Function to filter data by selected species -->
<!-- function filterData(data, selectedSpecies) { -->
<!--   return data.filter(d => d.common_name === selectedSpecies); -->
<!-- } -->

<!-- // Create the plot -->
<!-- function createPlot(data) { -->
<!--   return Plot.plot({ -->
<!--     // Customize your plot here (polar plot example) -->
<!--     marks: [ -->
<!--       <!-- Plot.line(data, { --> -->
<!--       plotPolarDetections(data, {//added by Shannon -->
<!--         x: "detection/hour", -->
<!--         y: "count", -->
<!--         stroke: "species", -->
<!--         // Add polar plot options as needed -->
<!--         bin='detection/hour', //added by Shannon -->
<!--         quantity='count'//added by Shannon -->
<!--       }) -->
<!--     ] -->
<!--   }); -->
<!-- } -->

<!-- // Render the plot and dropdown -->
<!-- display(dropdown); -->
<!-- display(createPlot(filterData(data, dropdown.value))); -->

<!-- // Update plot when dropdown changes -->
<!-- dropdown.addEventListener("input", () => { -->
<!--   display(createPlot(filterData(data, dropdown.value))); -->
<!-- }); -->
```

Boxplot

```{r RailBoxplot}
#| echo: false
#| warning: false


plotDetectionBoxplot(x=myData_priority_TJE,  group='species', facet = 'species', bin='hour/day', combineYears = FALSE, title = "Time Series BoxPlot showing the top 10 species detected at Tijuana Estuary")

```

Acoustic Scene

```{r RailAcScene}
#| echo: false
#| warning: false


plotAcousticScene(x=myData_priority_TJE, combineYears=FALSE) #Note: this would only be good for TJ

```

## Biodiversity Indices

In theory, long term acoustic recordings may provide a means of assessing biodiversity and habitat quality; or, at the least, changes in these metrics over time and in different regions.

Acoustic indices are quantitative metrics reflecting changes in the amplitude and frequency content of the soundscape over time (Sueur, 2018). Biodiversity indices, on their own, are of marginal value. Their value lies in their ability to quantify variation in the soundscape that may be indicative of *a change in the habitat or biodiversity over time or space*.

Many methods are sensitive to spectrogram dimensions and standard methods are required for interpretation. Here we provide examples of biodiversity indices for consideration; selection of specific measures will vary depending on research objectives.

cite: 10.1111/2041-210X.13254

## Acoustic Complexity Index

The Acoustic Complexity Index (ACI) uses a linear scale of sound intensity from sound spectrograms to analyze a soundscape. It is sensitive to irregularites in the biological soundscape (and other discrete sounds) while filtering out persistant anthropogenic sounds.

cite: 10.1016/j.ecolind.2010.11.005, 10.1016/j.ecoinf.2011.07.004

```{r ACI}
# Seewave Function = "ACI"
# Build in rails_Pilot.Rmd, then output here

```

## Acoustic Diversity Index

The Acoustic Diversity Index (ADI) uses the Shannon Index to measure the distribution of sound energy across frequency bins and was intended to serve as a proxy for habitat quality.

cite: 10.1007/s10980-011-9636-9

```{r ADI}
# Soundecology Function = "acoustic_diversity". 
# Build in rails_Pilot.Rmd, then output here
```

## Bioacoustic Index

Intended to serve as a measure of birdsong complexity (and a proxy for relative bird abundance), it is a product of the amplitude and the number of occupied frequency bands, relative to the quietest 1 kHz frequency band.

cite:10.1890/07-0004.1

```{r BI}
# Soundecology Function = "bioacoustic_index". 
# Build in rails_Pilot.Rmd, then output here
```

## Acoustic Entropy Index (AEI)

The Acoustic Entropy Index is based on the entropy in both time and space (based on the Shannon Index).

cite: 10.1371/journal.pone.0004065

```{r AEI}
# Seewave Function = "H". Minimum frequency = 0 kHz, maximum frequency = Nyquist of recording, FFT = 512. 
# Build in rails_Pilot.Rmd, then output here

```
